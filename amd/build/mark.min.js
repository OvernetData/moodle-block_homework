define(["jquery","block_homework/filterable_exportable_table","block_homework/bootstrap-switch","block_homework/form_validate"],function(a,b,c,d){"use strict";var e=function(){var c=M.str.block_homework,e=[],f=[],g=[];this.start=function(g){e=g.achievement,f=g.behaviour,0!==a("#ond_form").length&&(a("#btncancel").on("click",h),a("#btnsubmit").click(function(){d.validateInputs(i,l)}),a(".ond_subgroupcontroller").change(function(){var b=a(this),c=a("#"+b.attr("id")+"_subgroup_on"),d=a("#"+b.attr("id")+"_subgroup_off");b.prop("checked")||0===b[0].selectedIndex?(c.fadeIn(),d.fadeOut()):(c.fadeOut(),d.fadeIn())}).change(),a.fn.bootstrapSwitch&&a("input[type=checkbox][data-toggle=toggle]").bootstrapSwitch({handleWidth:40,labelWidth:1,onText:c.on,offText:c.off}),a("#achievementtype").on("change",j),j(),a("#behaviourtype").on("change",k),k(),a(".quickgrade").on("change",function(){var b=a(this),c=b.closest("tr");c.children().css("background-color","#e6ffe6");var d=b.prop("name").split("_"),e=d[1];a("#modified_"+e).val(1)}),b.initialise("ond_assign_marking",[0,"asc"],M.cfg.wwwroot+"/blocks/homework",{paging:!1,scrollY:!1}))};var h=function(){window.location=M.cfg.wwwroot+"/blocks/homework/view.php?course="+a("#course").val()+"&mark=1"},i=function(a){var b="";return b},j=function(){var b=a("#achievementpoints");b.length&&b.val(e[a("#achievementtype").val()])},k=function(){var b=a("#behaviourpoints");b.length&&b.val(f[a("#behaviourtype").val()])},l=function(){for(var e=a("#bulkachievement").prop("checked"),f=a("#bulkbehaviour").prop("checked"),h=b.getInputData(),i=a("#learners").val().split(","),j=[],k=0;k<i.length;k++){if(1==h.filter("#modified_"+i[k]).val()){var l=h.filter("[name=quickgrade_"+i[k]+"]").val();if(""!==l){var q={action:"mark",sesskey:a("#sesskey").val(),cmid:a("#id").val(),learnerid:i[k],name:h.filter("#name_"+i[k]).val(),grade:l,feedback:h.filter("#feedback_"+i[k]).val()};j.push(q)}}if(e&&1!=h.filter("#unsubmitted_"+i[k]).val()){var r={action:"achievement",sesskey:a("#sesskey").val(),cmid:a("#id").val(),learnerid:i[k],name:h.filter("#name_"+i[k]).val(),achievementtype:a("#achievementtype").val(),achievementactivity:a("#achievementactivity").val(),achievementcomments:a("#achievementcomments").val(),achievementpoints:a("#achievementpoints").val(),achievementreporter:a("#achievementreporter").val()};j.push(r)}if(f&&1==h.filter("#unsubmitted_"+i[k]).val()){var s={action:"behaviour",sesskey:a("#sesskey").val(),cmid:a("#id").val(),learnerid:i[k],name:h.filter("#name_"+i[k]).val(),behaviourtype:a("#behaviourtype").val(),behaviouractivity:a("#behaviouractivity").val(),behaviourstatus:a("#behaviourstatus").val(),behaviourcomments:a("#behaviourcomments").val(),behaviourpoints:a("#behaviourpoints").val(),behaviourreporter:a("#behaviourreporter").val()};j.push(s)}}if(0===j.length)d.showDialog(c.nothingdone,c.nothingdonefull,c.ok);else{var t=0;n(j,10,function(b,d){"mark"===b.action?(o(t/j.length*100,c.gradingassignmentfor+" "+b.name),a.post("ajax/mark_assignment.php",b).done(function(a,b,d){if(!a.success){var e=c.failedtosetmarkfor+" "+a.name+"; "+a.error;g.push(e)}}).fail(function(b,d,e){var f=p(a(this)[0].data),h=c.failedtosetmarkfor+f.name+"; "+e;g.push(h)}).always(function(){t+=.5,o(t/j.length*100,c.savinggrades),t>=j.length&&m(g)})):"achievement"===b.action?(o(t/j.length*100,c.addingachievementfor+" "+b.name),a.post("ajax/write_behaviour.php",b).done(function(a,b,d){if(!a.success){var e=c.failedtoaddachievementfor+" "+a.name+"; "+a.error;g.push(e)}}).fail(function(b,d,e){var f=p(a(this)[0].data),h=c.failedtoaddachievementfor+" "+f.name+"; "+e;g.push(h)}).always(function(){t+=.5,o(t/j.length*100,c.savingachievement),t>=j.length&&m(g)})):"behaviour"===b.action&&(o(t/j.length*100,c.addingbehaviourfor+" "+b.name),a.post("ajax/write_behaviour.php",b).done(function(a,b,d){if(!a.success){var e=c.failedtoaddbehaviourfor+" "+a.name+"; "+a.error;g.push(e)}}).fail(function(b,d,e){var f=p(a(this)[0].data),h=c.failedtoaddbehaviourfor+" "+f.name+"; "+e;g.push(h)}).always(function(){t+=.5,o(t/j.length*100,c.savingbehaviour),t>=j.length&&m(g)})),t+=.5,o(t/j.length*100),t>=j.length&&m(g)})}},m=function(b){var d=c.alldone,e="";b.length>0?(e='<div class="ond_centered"><button id="ond_btn_retry" type="button" class="ond_material_button_raised">'+c.tryagain+'</button><button id="ond_btn_cancel" type="button" class="ond_material_button_raised">'+c.cancel+"</button></div>",d+=", "+b.length+" error(s)",a("#ond_form_progress").after('<div id="ond_errors"><pre>'+b.join("<br>")+"</pre></div>").after(e),a("#ond_btn_retry").on("click",function(){location.reload()}),a("#ond_btn_cancel").on("click",h)):(e='<div class="ond_centered"><button id="ond_btn_ok" type="button" class="ond_material_button_raised">'+c.ok+"</button></div>",a("#ond_form_progress").after(e),a("#ond_btn_ok").on("click",h)),o(100,d)},n=function(a,b,c){var d=null,e=0,f=function(){e!==a.length&&(c.call(d,a[e],e),e++,setTimeout(f,b))};f()},o=function(b,d){d=d||c.saving,b=Math.round(b);var e=a("#ond_form_progress");"none"===e.css("display")&&(a("#ond_form").css("display","none"),e.css("display","block"));var f=b*e.width()/100,g=d+'<div id="ond_form_progress_bar_number">'+b+"%</div>";a("#ond_form_progress_bar").css("width",f).animate(100).html(g)},p=function(a){for(var b=a.split("&"),c={},d=0;d<b.length;d++){var e=b[d].split("=");c[e[0]]=decodeURIComponent(e[1].replace(/\+/g,"%20")||"")}return JSON.parse(JSON.stringify(c))}};return new e});