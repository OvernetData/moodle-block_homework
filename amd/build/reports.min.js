define(["jquery","theme_bootstrapbase/bootstrap","block_homework/filterable_exportable_table","block_homework/Chart","block_homework/select2"],function(a,b,c,d,e){"use strict";var f=function(){var b=!1,d=!1,e=!1,f=!1,g=!1,h=!1,i=!1,j=!1,k=!1,l=M.cfg.wwwroot+"/blocks/homework/ajax/",m=M.str.block_homework;this.start=function(b){a("#user").on("change",o).attr("style","width:30%").select2(),a("#from_staff").on("change",o),a("#to_staff").on("change",o),a("#grouptableholder").length&&(a("#group").on("change",p).attr("style","width:30%").select2(),a("#from_group").on("change",p),a("#to_group").on("change",p));var c=M.cfg.wwwroot+"/blocks/homework/ajax/lookup_user.php";b&&(c=M.cfg.wwwroot+"/blocks/mis_portal/ajax/homework_lookup_student.php"),a("#student").on("change",q).attr("style","width:30%").select2({ajax:{url:c,dataType:"json",delay:250,data:function(b){return{sesskey:a("#sesskey").val(),q:b.term,page:b.page}},processResults:function(a,b){return b.page=b.page||1,{results:a.data.items,pagination:{more:30*b.page<a.data.total_count}}},cache:!0},escapeMarkup:function(a){return a},minimumInputLength:2,templateResult:r,templateSelection:s}),a("#from_student").on("change",q),a("#to_student").on("change",q),a("#from_school").on("change",t),a("#to_school").on("change",t),a("#loguser").on("change",u).attr("style","width:30%").select2(),a("#from_log").on("change",u),a("#to_log").on("change",u),a("#Group_Grades-tab").on("shown.bs.tab",function(a){h||(h=!0,p())}),a("#Student_Grades-tab").on("shown.bs.tab",function(a){i||(i=!0,q())}),a("#Subjects_and_Staff-tab").on("shown.bs.tab",function(a){j||(j=!0,t())}),a("#Notifications_Log-tab").on("shown.bs.tab",function(a){k||(k=!0,u())}),o()};var n=function(a,b){"undefined"==typeof b&&(b=m.loadingdata);var c=document.getElementById(a),d=c.getContext("2d");d.clearRect(0,0,c.width,c.height),d.textBaseline="middle",d.textAlign="center",d.fillStyle="#888888",d.font="30pt Helvetica",d.fillText(b,c.width/2,c.height/2)},o=function(){a("#user").prop("disabled",!0),a("#from_staff").prop("disabled",!0),a("#to_staff").prop("disabled",!0),n("mychart1"),n("mychart2"),n("mychart3");var c=l+"reports_staff.php",f={course:a("#course").val(),sesskey:a("#sesskey").val(),user:a("#user").val(),from:a("#from_staff").val(),to:a("#to_staff").val()};a.ajax({method:"POST",url:c,data:f}).done(function(c,f,g){if("undefined"==typeof c.error){var h=document.getElementById("mychart1").getContext("2d");b&&b.destroy(),b=new Chart(h).Bar(c.chart1);var i=document.getElementById("mychart2").getContext("2d");d&&d.destroy(),d=new Chart(i).Bar(c.chart2);var j=document.getElementById("mychart3").getContext("2d");e&&e.destroy(),e=new Chart(j).Pie(c.chart3,{showTooltips:!0,onAnimationComplete:function(){this.showTooltip(this.segments,!0)},tooltipTemplate:"<%= label %> - <%= value %>"})}else n("mychart1",c.error),n("mychart2",c.error),n("mychart3",c.error);a("#user").prop("disabled",!1),a("#from_staff").prop("disabled",!1),a("#to_staff").prop("disabled",!1)}).fail(function(b,c,d){n("mychart1",d),n("mychart2",d),n("mychart3",d),a("#user").prop("disabled",!1),a("#from_staff").prop("disabled",!1),a("#to_staff").prop("disabled",!1)})},p=function(){var b=a("#grouptableholder");if(b.length){a("#group").prop("disabled",!0),a("#from_group").prop("disabled",!0),a("#to_group").prop("disabled",!0),a("#groupgrades_loaded").css("display","none"),a("#groupgrades_loading").css("display","block");var d=l+"reports_group.php",e={course:a("#course").val(),sesskey:a("#sesskey").val(),group:a("#group").val(),from:a("#from_group").val(),to:a("#to_group").val()};a.ajax({method:"POST",url:d,data:e}).done(function(d,e,f){"undefined"==typeof d.error?(b.html(d.html),c.initialise("groupgrades",null,M.cfg.wwwroot+"/blocks/homework")):(a("#groupgrades_loading").css("display","none"),a("#groupgrades_loaded").html('<h4 class="ond_failure">'+d.error+"</h4>"),a("#groupgrades_loaded").css("display","block")),a("#group").prop("disabled",!1),a("#from_group").prop("disabled",!1),a("#to_group").prop("disabled",!1)}).fail(function(b,c,d){a("#groupgrades_loading").css("display","none"),a("#groupgrades_loaded").html('<h4 class="ond_failure">'+d+"</h4>"),a("#groupgrades_loaded").css("display","block"),a("#group").prop("disabled",!1),a("#from_group").prop("disabled",!1),a("#to_group").prop("disabled",!1)})}},q=function(){var b=a("#student").val();if(b){a("#student").prop("disabled",!0),a("#from_student").prop("disabled",!0),a("#to_student").prop("disabled",!0),a("#studentgrades_loaded").css("display","none"),a("#studentgrades_loading").css("display","block");var d=l+"reports_student.php",e={course:a("#course").val(),sesskey:a("#sesskey").val(),student:b,from:a("#from_student").val(),to:a("#to_student").val()};a.ajax({method:"POST",url:d,data:e}).done(function(b,d,e){"undefined"==typeof b.error?(a("#studenttableholder").html(b.html),c.initialise("studentgrades",null,M.cfg.wwwroot+"/blocks/homework")):(a("#selectstudentmessage").css("display","none"),a("#studentgrades_loading").css("display","none"),a("#studentgrades_loaded").html('<h4 class="ond_failure">'+b.error+"</h4>"),a("#studentgrades_loaded").css("display","block")),a("#student").prop("disabled",!1),a("#from_student").prop("disabled",!1),a("#to_student").prop("disabled",!1)}).fail(function(b,c,d){a("#selectstudentmessage").css("display","none"),a("#studentgrades_loading").css("display","none"),a("#studentgrades_loaded").html('<h4 class="ond_failure">'+d+"</h4>"),a("#studentgrades_loaded").css("display","block"),a("#student").prop("disabled",!1),a("#from_student").prop("disabled",!1),a("#to_student").prop("disabled",!1)})}},r=function(a){if(a.loading)return a.text;var b="<div class='ond_student_lookup clearfix'>";return a.photourl&&(b+="<div class='ond_student_lookup_avatar'><img src='"+a.photourl+"' /></div>"),b+="<div class='ond_student_lookup_meta'><div class='ond_student_lookup_name'>"+a.forename+" "+a.surname+"</div><div class='ond_student_lookup_attributes'>",a.yeargroup&&(b+="<div class='ond_student_lookup_year'>"+m.year+" "+a.yeargroup+"</div>"),a.formgroup&&(b+="<div class='ond_student_lookup_form'>"+m.formgroup+" "+a.formgroup+"</div>"),a.community&&(b+="<div class='ond_student_lookup_community'>"+m.community+" "+a.community+"</div>"),b+="</div></div></div>"},s=function(a){return a.forename+" "+a.surname||a.text},t=function(){a("#from_school").prop("disabled",!0),a("#to_school").prop("disabled",!0),n("mychart4"),n("mychart5"),a("#staffstatistics_loaded").css("display","none"),a("#staffstatistics_loading").css("display","block");var b=l+"reports_school.php",d={course:a("#course").val(),sesskey:a("#sesskey").val(),from:a("#from_school").val(),to:a("#to_school").val()};a.ajax({method:"POST",url:b,data:d}).done(function(b,d,e){if("undefined"==typeof b.error){var h=document.getElementById("mychart4").getContext("2d");f&&f.destroy(),f=new Chart(h).Pie(b.chart4,{showTooltips:!0,onAnimationComplete:function(){this.showTooltip(this.segments,!0)},tooltipTemplate:"<%= label %> - <%= value %>"});var i=document.getElementById("mychart5").getContext("2d");g&&g.destroy(),g=new Chart(i).Pie(b.chart5,{showTooltips:!0,onAnimationComplete:function(){this.showTooltip(this.segments,!0)},tooltipTemplate:"<%= label %> - <%= value %>"}),a("#staffstatisticstableholder").html(b.html),c.initialise("staffstatistics",null,M.cfg.wwwroot+"/blocks/homework")}else n("mychart4",b.error),n("mychart5",b.error),a("#staffstatistics_loading").css("display","none"),a("#staffstatistics_loaded").html('<h4 class="ond_failure">'+b.error+"</h4>"),a("#staffstatistics_loaded").css("display","block");a("#from_school").prop("disabled",!1),a("#to_school").prop("disabled",!1)}).fail(function(b,c,d){n("mychart4",d),n("mychart5",d),a("#staffstatistics_loading").css("display","none"),a("#staffstatistics_loaded").html('<h4 class="ond_failure">'+d+"</h4>"),a("#staffstatistics_loaded").css("display","block"),a("#from_school").prop("disabled",!1),a("#to_school").prop("disabled",!1)})},u=function(){var b=a("#logtableholder");if(b.length){a("#loguser").prop("disabled",!0),a("#from_log").prop("disabled",!0),a("#to_log").prop("disabled",!0),a("#log_loaded").css("display","none"),a("#log_loading").css("display","block");var d=l+"reports_log.php",e={course:a("#course").val(),sesskey:a("#sesskey").val(),user:a("#loguser").val(),from:a("#from_log").val(),to:a("#to_log").val()};a.ajax({method:"POST",url:d,data:e}).done(function(d,e,f){"undefined"==typeof d.error?(b.html(d.html),c.initialise("log",null,M.cfg.wwwroot+"/blocks/homework")):(a("#log_loading").css("display","none"),a("#log_loaded").html('<h4 class="ond_failure">'+d.error+"</h4>"),a("#log_loaded").css("display","block")),a("#loguser").prop("disabled",!1),a("#from_log").prop("disabled",!1),a("#to_log").prop("disabled",!1)}).fail(function(b,c,d){a("#log_loading").css("display","none"),a("#log_loaded").html('<h4 class="ond_failure">'+d+"</h4>"),a("#log_loaded").css("display","block"),a("#loguser").prop("disabled",!1),a("#from_log").prop("disabled",!1),a("#to_log").prop("disabled",!1)})}}};return new f});